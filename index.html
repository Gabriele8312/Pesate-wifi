<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pesate Raccolto - Multi Utente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 90vh;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* PULSANTE HOME ABBASSATO */
        .back-btn {
            position: absolute;
            left: 15px;
            top: 65%; /* Abbassato dal 50% al 65% */
            transform: translateY(-50%);
            background: rgba(255,255,255,0.25);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            display: none;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

        .back-btn:active {
            transform: translateY(-50%) scale(0.95);
            background: rgba(255,255,255,0.4);
        }

        .sync-status {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
        }

        .content {
            padding: 25px 20px;
        }

        /* HOME SCREEN */
        .home-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-card {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .menu-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #e9ecef;
            transform: none !important;
        }

        .menu-icon {
            font-size: 42px;
            margin-bottom: 12px;
            display: block;
        }

        .menu-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .menu-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .stats-home {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 22px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            background: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* PESO LORDO INGRANDITO PER VISIBILIT√Ä AL SOLE */
        .peso-lordo-input {
            font-size: 28px !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 20px !important;
            background: #ffffff !important;
            border: 3px solid #4CAF50 !important;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3) !important;
            color: #2e7d32 !important;
            min-height: 80px !important;
        }

        .peso-lordo-input:focus {
            border-color: #2e7d32 !important;
            box-shadow: 0 0 0 5px rgba(76, 175, 80, 0.2) !important;
            background: #f1f8e9 !important;
        }

        /* DROPDOWN MIGLIORATO PER OPERATORI */
        .operator-select-container {
            position: relative;
        }

        .operator-select {
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .operator-select::after {
            content: "‚ñº";
            font-size: 12px;
            color: #666;
        }

        .operator-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .operator-dropdown.show {
            display: block;
        }

        .operator-option {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .operator-option:hover {
            background: #f8f9fa;
        }

        .operator-option:last-child {
            border-bottom: none;
        }

        .new-operator-option {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #1a73e8;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }

        .btn-secondary:hover {
            background: #1557b0;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }

        /* FIELD SUGGESTIONS */
        .field-suggestions {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 120px;
            overflow-y: auto;
            display: none;
        }

        .field-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background: #e9ecef;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* SCREEN MANAGEMENT */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .pesata-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .peso {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .dettagli {
            font-size: 13px;
            color: #555;
            line-height: 1.4;
        }

        .totale {
            background: #4CAF50;
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .totale-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .totale-peso {
            font-weight: bold;
            color: #4CAF50;
        }

        .loading {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        /* RESPONSIVE IMPROVEMENTS */
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .back-btn {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 70px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .menu-card {
                padding: 20px;
            }
            
            .menu-icon {
                font-size: 38px;
            }

            .peso-lordo-input {
                font-size: 24px !important;
                min-height: 70px !important;
                padding: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="tornaHome()" id="backBtn">üè† Home</button>
            <h1 id="headerTitle">üåæ Gestione Raccolto</h1>
            <p id="headerSubtitle">Cascina Digitale - Multi Utente</p>
            <div class="sync-status" id="syncStatus">‚ö° Connesso</div>
        </div>

        <div class="content">
            <!-- HOME SCREEN -->
            <div id="home" class="screen active">
                <div class="stats-home">
                    <div>üìä Situazione Attuale (Tempo Reale)</div>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-number" id="homeStatPesate">-</div>
                            <div class="stat-label">Pesate</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="homeStatKg">-</div>
                            <div class="stat-label">kg Totali</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="homeStatOperatori">-</div>
                            <div class="stat-label">Operatori</div>
                        </div>
                    </div>
                    <button class="config-btn" onclick="aggiornaStats()" style="margin-top: 15px; padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; cursor: pointer;">üîÑ Aggiorna Ora</button>
                </div>

                <div class="home-menu">
                    <div class="menu-card" id="menuInserimento" onclick="vaiA('inserimento')">
                        <span class="menu-icon">üìù</span>
                        <div class="menu-title">Nuova Pesata</div>
                        <div class="menu-desc">Registra una nuova pesata del raccolto</div>
                    </div>

                    <div class="menu-card" id="menuElenco" onclick="vaiA('elenco')">
                        <span class="menu-icon">üìã</span>
                        <div class="menu-title">Elenco Pesate</div>
                        <div class="menu-desc">Visualizza tutte le pesate (tempo reale)</div>
                    </div>

                    <div class="menu-card" id="menuTotali" onclick="vaiA('totali')">
                        <span class="menu-icon">üìä</span>
                        <div class="menu-title">Report Totali</div>
                        <div class="menu-desc">Riepiloghi aggiornati in tempo reale</div>
                    </div>

                    <div class="menu-card" onclick="apriGoogleSheets()">
                        <span class="menu-icon">üì±</span>
                        <div class="menu-title">Apri Google Sheets</div>
                        <div class="menu-desc">Visualizza il foglio completo</div>
                    </div>
                </div>
            </div>

            <!-- INSERIMENTO SCREEN -->
            <div id="inserimento" class="screen">
                <!-- SELEZIONE OPERATORE CON DROPDOWN -->
                <div class="form-group">
                    <label>Seleziona Operatore</label>
                    <div class="operator-select-container">
                        <div class="operator-select" onclick="toggleOperatorDropdown()">
                            <span id="selectedOperator">Seleziona o crea nuovo operatore...</span>
                        </div>
                        <div class="operator-dropdown" id="operatorDropdown">
                            <div class="operator-option new-operator-option" onclick="nuovoOperatore()">
                                ‚ûï Nuovo Operatore
                            </div>
                            <div id="existingOperators"></div>
                        </div>
                    </div>
                </div>

                <!-- INPUT MANUALE PER NUOVO OPERATORE -->
                <div class="form-group" id="newOperatorGroup" style="display: none;">
                    <label>ID Nuovo Operatore</label>
                    <input type="text" id="nuovoOperatore" placeholder="Inserisci ID operatore (es. OP001)" style="text-transform: uppercase;">
                </div>

                <div class="form-group">
                    <label>Campo</label>
                    <input type="text" id="campo" placeholder="Nome del campo" onkeyup="mostraSuggerimenti(this, 'campi')">
                    <div class="field-suggestions" id="suggerimentiCampi"></div>
                </div>

                <div class="form-group">
                    <label>Magazzino</label>
                    <input type="text" id="magazzino" placeholder="Nome magazzino/silo" onkeyup="mostraSuggerimenti(this, 'magazzini')">
                    <div class="field-suggestions" id="suggerimentiMagazzini"></div>
                </div>

                <div class="form-group">
                    <label>Peso Lordo (kg) - OTTIMIZZATO PER SOLE</label>
                    <input type="number" id="pesoLordo" class="peso-lordo-input" step="0.1" placeholder="0.0" onchange="calcolaPesoNetto()">
                </div>

                <div class="form-group">
                    <label>Tara (kg)</label>
                    <input type="number" id="tara" step="0.1" value="0" placeholder="0.0" onchange="calcolaPesoNetto()">
                </div>

                <div class="form-group">
                    <label>Peso Netto (kg) - Automatico</label>
                    <input type="number" id="pesoNetto" readonly style="background: #e9ecef; font-weight: bold; color: #4CAF50; font-size: 18px;">
                </div>

                <div class="form-group">
                    <label>Prodotto</label>
                    <input type="text" id="prodotto" placeholder="Nome del prodotto" onkeyup="mostraSuggerimenti(this, 'prodotti')">
                    <div class="field-suggestions" id="suggerimentiProdotti"></div>
                </div>

                <button class="btn" id="btnRegistra" onclick="registraPesata()">üìù REGISTRA PESATA</button>
                <div id="messaggiInserimento"></div>
            </div>

            <!-- ELENCO SCREEN -->
            <div id="elenco" class="screen">
                <button class="btn btn-secondary" onclick="caricaDatiCompleti()" style="margin-bottom: 20px;">üîÑ Ricarica Dati</button>
                <div id="elencoPesate">
                    <div class="loading">Caricamento pesate in corso...</div>
                </div>
            </div>

            <!-- TOTALI SCREEN -->
            <div id="totali" class="screen">
                <button class="btn btn-secondary" onclick="caricaTotali()" style="margin-bottom: 20px;">üîÑ Ricarica Totali</button>
                <div id="reportTotali">
                    <div class="loading">Caricamento report in corso...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
       
        const API_URL = 'https://script.google.com/macros/s/AKfycbz0O8hcU7XRueFf5YMZe7SOF6YTD88H1J86OAgL1n1qFGUWmz9OSsmIhjbj7p9PP4MB/exec';
        
        // üìä GESTIONE GLOBALE DATI
        let operatoriEsistenti = [];
        let suggerimenti = {
            campi: [],
            magazzini: [],
            prodotti: []
        };
        let operatoreSelezionato = '';

        // üè† INIZIALIZZAZIONE APP
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App caricata - API configurato:', API_URL);
            aggiornaStats();
            caricaOperatori();
        });

        // üì± NAVIGAZIONE TRA SCHERMATE
        function vaiA(schermata) {
            // Nascondi tutte le schermate
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Mostra schermata selezionata
            document.getElementById(schermata).classList.add('active');
            
            // Gestisci header
            const backBtn = document.getElementById('backBtn');
            const headerTitle = document.getElementById('headerTitle');
            
            if (schermata === 'home') {
                backBtn.style.display = 'none';
                headerTitle.textContent = 'üåæ Gestione Raccolto';
            } else {
                backBtn.style.display = 'block';
                
                const titoli = {
                    'inserimento': 'üìù Nuova Pesata',
                    'elenco': 'üìã Elenco Pesate',
                    'totali': 'üìä Report Totali'
                };
                headerTitle.textContent = titoli[schermata] || 'üåæ Gestione Raccolto';
            }

            // Carica dati specifici per schermata
            if (schermata === 'elenco') {
                caricaDatiCompleti();
            } else if (schermata === 'totali') {
                caricaTotali();
            } else if (schermata === 'inserimento') {
                resetFormInserimento();
                caricaOperatori();
            }
        }

        function tornaHome() {
            vaiA('home');
        }

        // üìä AGGIORNAMENTO STATISTICHE HOME
        async function aggiornaStats() {
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.pesate) {
                    const pesate = data.pesate;
                    const totalePesate = pesate.length;
                    const totaleKg = pesate.reduce((sum, p) => sum + parseFloat(p.pesoNetto || 0), 0);
                    const operatoriUnici = [...new Set(pesate.map(p => p.operatore))].length;
                    
                    document.getElementById('homeStatPesate').textContent = totalePesate;
                    document.getElementById('homeStatKg').textContent = totaleKg.toFixed(1);
                    document.getElementById('homeStatOperatori').textContent = operatoriUnici;
                    
                    document.getElementById('syncStatus').innerHTML = '‚úÖ Aggiornato';
                } else {
                    throw new Error(data.error || 'Errore nel caricamento dati');
                }
            } catch (error) {
                console.error('Errore stats:', error);
                document.getElementById('syncStatus').innerHTML = '‚ùå Errore';
                document.getElementById('homeStatPesate').textContent = '?';
                document.getElementById('homeStatKg').textContent = '?';
                document.getElementById('homeStatOperatori').textContent = '?';
            }
        }

        // üë• GESTIONE OPERATORI
        async function caricaOperatori() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success && data.pesate) {
                    // Estrai operatori unici
                    const operatori = [...new Set(data.pesate
                        .map(p => p.operatore)
                        .filter(op => op && op.trim())
                    )].sort();
                    
                    operatoriEsistenti = operatori;
                    aggiornaDropdownOperatori();
                    
                    // Aggiorna suggerimenti
                    suggerimenti.campi = [...new Set(data.pesate.map(p => p.campo).filter(c => c))];
                    suggerimenti.magazzini = [...new Set(data.pesate.map(p => p.magazzino).filter(m => m))];
                    suggerimenti.prodotti = [...new Set(data.pesate.map(p => p.prodotto).filter(pr => pr))];
                }
            } catch (error) {
                console.error('Errore caricamento operatori:', error);
            }
        }

        function aggiornaDropdownOperatori() {
            const container = document.getElementById('existingOperators');
            container.innerHTML = '';
            
            operatoriEsistenti.forEach(operatore => {
                const div = document.createElement('div');
                div.className = 'operator-option';
                div.textContent = operatore;
                div.onclick = () => selezionaOperatore(operatore);
                container.appendChild(div);
            });
        }

        function toggleOperatorDropdown() {
            const dropdown = document.getElementById('operatorDropdown');
            dropdown.classList.toggle('show');
        }

        function selezionaOperatore(operatore) {
            operatoreSelezionato = operatore;
            document.getElementById('selectedOperator').textContent = operatore;
            document.getElementById('operatorDropdown').classList.remove('show');
            document.getElementById('newOperatorGroup').style.display = 'none';
            document.getElementById('nuovoOperatore').value = '';
        }

        function nuovoOperatore() {
            document.getElementById('selectedOperator').textContent = 'Nuovo Operatore';
            document.getElementById('operatorDropdown').classList.remove('show');
            document.getElementById('newOperatorGroup').style.display = 'block';
            document.getElementById('nuovoOperatore').focus();
            operatoreSelezionato = '';
        }

        // üí° SUGGERIMENTI CAMPI
        function mostraSuggerimenti(input, tipo) {
            const valore = input.value.toLowerCase();
            const suggerimentiContainer = input.parentNode.querySelector('.field-suggestions');
            const items = suggerimenti[tipo] || [];
            
            if (!valore || items.length === 0) {
                suggerimentiContainer.classList.remove('show');
                return;
            }
            
            const filtrati = items.filter(item => 
                item.toLowerCase().includes(valore)
            );
            
            if (filtrati.length === 0) {
                suggerimentiContainer.classList.remove('show');
                return;
            }
            
            suggerimentiContainer.innerHTML = '';
            filtrati.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item;
                div.onclick = () => {
                    input.value = item;
                    suggerimentiContainer.classList.remove('show');
                };
                suggerimentiContainer.appendChild(div);
            });
            
            suggerimentiContainer.classList.add('show');
        }

        // üßÆ CALCOLO PESO NETTO
        function calcolaPesoNetto() {
            const pesoLordo = parseFloat(document.getElementById('pesoLordo').value) || 0;
            const tara = parseFloat(document.getElementById('tara').value) || 0;
            const pesoNetto = Math.max(0, pesoLordo - tara);
            
            document.getElementById('pesoNetto').value = pesoNetto.toFixed(1);
        }

        // üíæ REGISTRAZIONE PESATA
        async function registraPesata() {
            const btn = document.getElementById('btnRegistra');
            const messages = document.getElementById('messaggiInserimento');
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Registrando...';
                
                // Determina operatore
                let operatore = operatoreSelezionato;
                if (!operatore) {
                    operatore = document.getElementById('nuovoOperatore').value.trim().toUpperCase();
                }
                
                // Validazione
                const campo = document.getElementById('campo').value.trim();
                const magazzino = document.getElementById('magazzino').value.trim();
                const pesoLordo = parseFloat(document.getElementById('pesoLordo').value);
                const tara = parseFloat(document.getElementById('tara').value) || 0;
                const pesoNetto = parseFloat(document.getElementById('pesoNetto').value);
                const prodotto = document.getElementById('prodotto').value.trim();
                
                if (!operatore) {
                    throw new Error('Seleziona o inserisci un operatore');
                }
                if (!campo) {
                    throw new Error('Inserisci il nome del campo');
                }
                if (!magazzino) {
                    throw new Error('Inserisci il magazzino');
                }
                if (!pesoLordo || pesoLordo <= 0) {
                    throw new Error('Inserisci un peso lordo valido');
                }
                if (!prodotto) {
                    throw new Error('Inserisci il nome del prodotto');
                }
                
                // Prepara dati
                const datiPesata = {
                    operatore: operatore,
                    campo: campo,
                    magazzino: magazzino,
                    pesoLordo: pesoLordo,
                    tara: tara,
                    pesoNetto: pesoNetto,
                    prodotto: prodotto,
                    timestamp: new Date().toISOString(),
                    action: 'add'
                };
                
                // Invio dati
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datiPesata)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    messages.innerHTML = '<div class="success">‚úÖ Pesata registrata con successo!</div>';
                    resetFormInserimento();
                    aggiornaStats();
                    caricaOperatori(); // Ricarica operatori per aggiornare la lista
                } else {
                    throw new Error(result.error || 'Errore durante la registrazione');
                }
                
            } catch (error) {
                console.error('Errore registrazione:', error);
                messages.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìù REGISTRA PESATA';
            }
        }

        // üîÑ RESET FORM INSERIMENTO
        function resetFormInserimento() {
            document.getElementById('selectedOperator').textContent = 'Seleziona o crea nuovo operatore...';
            document.getElementById('newOperatorGroup').style.display = 'none';
            document.getElementById('nuovoOperatore').value = '';
            document.getElementById('campo').value = '';
            document.getElementById('magazzino').value = '';
            document.getElementById('pesoLordo').value = '';
            document.getElementById('tara').value = '0';
            document.getElementById('pesoNetto').value = '';
            document.getElementById('prodotto').value = '';
            document.getElementById('messaggiInserimento').innerHTML = '';
            operatoreSelezionato = '';
            
            // Nascondi tutti i suggerimenti
            document.querySelectorAll('.field-suggestions').forEach(s => s.classList.remove('show'));
        }

        // üìã CARICAMENTO DATI COMPLETI
        async function caricaDatiCompleti() {
            const container = document.getElementById('elencoPesate');
            
            try {
                container.innerHTML = '<div class="loading">‚è≥ Caricamento pesate...</div>';
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.pesate) {
                    const pesate = data.pesate;
                    
                    if (pesate.length === 0) {
                        container.innerHTML = '<div class="loading">üìù Nessuna pesata registrata</div>';
                        return;
                    }
                    
                    // Ordina per timestamp decrescente (pi√π recenti prima)
                    pesate.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    let html = '';
                    pesate.forEach((pesata, index) => {
                        const data = new Date(pesata.timestamp).toLocaleDateString('it-IT');
                        const ora = new Date(pesata.timestamp).toLocaleTimeString('it-IT', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        html += `
                            <div class="pesata-item">
                                <div class="peso">${parseFloat(pesata.pesoNetto || 0).toFixed(1)} kg</div>
                                <div class="dettagli">
                                    <strong>${pesata.operatore || 'N/D'}</strong> ‚Ä¢ ${pesata.prodotto || 'N/D'}<br>
                                    üìç Campo: ${pesata.campo || 'N/D'} ‚Üí ${pesata.magazzino || 'N/D'}<br>
                                    ‚öñÔ∏è Lordo: ${parseFloat(pesata.pesoLordo || 0).toFixed(1)} kg - Tara: ${parseFloat(pesata.tara || 0).toFixed(1)} kg<br>
                                    üïê ${data} alle ${ora}
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                } else {
                    throw new Error(data.error || 'Errore nel caricamento pesate');
                }
                
            } catch (error) {
                console.error('Errore caricamento pesate:', error);
                container.innerHTML = `<div class="error">‚ùå Errore nel caricamento: ${error.message}</div>`;
            }
        }

        // üìä CARICAMENTO TOTALI
        async function caricaTotali() {
            const container = document.getElementById('reportTotali');
            
            try {
                container.innerHTML = '<div class="loading">‚è≥ Caricamento report...</div>';
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.pesate) {
                    const pesate = data.pesate;
                    
                    if (pesate.length === 0) {
                        container.innerHTML = '<div class="loading">üìä Nessun dato per i report</div>';
                        return;
                    }
                    
                    // Calcola totali
                    const totaleGenerale = pesate.reduce((sum, p) => sum + parseFloat(p.pesoNetto || 0), 0);
                    
                    // Raggruppa per operatore
                    const perOperatore = {};
                    pesate.forEach(p => {
                        const op = p.operatore || 'N/D';
                        if (!perOperatore[op]) {
                            perOperatore[op] = { pesate: 0, kg: 0 };
                        }
                        perOperatore[op].pesate++;
                        perOperatore[op].kg += parseFloat(p.pesoNetto || 0);
                    });
                    
                    // Raggruppa per prodotto
                    const perProdotto = {};
                    pesate.forEach(p => {
                        const prod = p.prodotto || 'N/D';
                        if (!perProdotto[prod]) {
                            perProdotto[prod] = { pesate: 0, kg: 0 };
                        }
                        perProdotto[prod].pesate++;
                        perProdotto[prod].kg += parseFloat(p.pesoNetto || 0);
                    });
                    
                    // Raggruppa per campo
                    const perCampo = {};
                    pesate.forEach(p => {
                        const campo = p.campo || 'N/D';
                        if (!perCampo[campo]) {
                            perCampo[campo] = { pesate: 0, kg: 0 };
                        }
                        perCampo[campo].pesate++;
                        perCampo[campo].kg += parseFloat(p.pesoNetto || 0);
                    });
                    
                    let html = `
                        <div class="totale">
                            üìä TOTALE GENERALE: ${totaleGenerale.toFixed(1)} kg
                            <br>
                            <small>${pesate.length} pesate registrate</small>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0; color: #333;">üë• Per Operatore</h3>
                    `;
                    
                    Object.entries(perOperatore)
                        .sort((a, b) => b[1].kg - a[1].kg)
                        .forEach(([operatore, dati]) => {
                            html += `
                                <div class="totale-item">
                                    <span><strong>${operatore}</strong> (${dati.pesate} pesate)</span>
                                    <span class="totale-peso">${dati.kg.toFixed(1)} kg</span>
                                </div>
                            `;
                        });
                    
                    html += '<h3 style="margin: 20px 0 10px 0; color: #333;">üåæ Per Prodotto</h3>';
                    Object.entries(perProdotto)
                        .sort((a, b) => b[1].kg - a[1].kg)
                        .forEach(([prodotto, dati]) => {
                            html += `
                                <div class="totale-item">
                                    <span><strong>${prodotto}</strong> (${dati.pesate} pesate)</span>
                                    <span class="totale-peso">${dati.kg.toFixed(1)} kg</span>
                                </div>
                            `;
                        });
                    
                    html += '<h3 style="margin: 20px 0 10px 0; color: #333;">üìç Per Campo</h3>';
                    Object.entries(perCampo)
                        .sort((a, b) => b[1].kg - a[1].kg)
                        .forEach(([campo, dati]) => {
                            html += `
                                <div class="totale-item">
                                    <span><strong>${campo}</strong> (${dati.pesate} pesate)</span>
                                    <span class="totale-peso">${dati.kg.toFixed(1)} kg</span>
                                </div>
                            `;
                        });
                    
                    container.innerHTML = html;
                } else {
                    throw new Error(data.error || 'Errore nel caricamento report');
                }
                
            } catch (error) {
                console.error('Errore caricamento totali:', error);
                container.innerHTML = `<div class="error">‚ùå Errore nel caricamento: ${error.message}</div>`;
            }
        }

        // üì± APERTURA GOOGLE SHEETS
        function apriGoogleSheets() {
            // Estrai l'ID dello script dall'URL API
            const scriptMatch = API_URL.match(/\/s\/([a-zA-Z0-9-_]+)\//);
            
            if (scriptMatch && scriptMatch[1]) {
                // Questo dovrebbe essere sostituito con l'ID effettivo del Google Sheet
                // Per ora mostra un messaggio all'utente
                alert('üí° Per aprire Google Sheets:\n\n1. Vai su sheets.google.com\n2. Cerca il foglio "Gestione Pesate Raccolto"\n3. Oppure usa l\'URL che ti ha fornito il tuo amministratore');
            } else {
                alert('‚ö†Ô∏è URL Google Sheets non configurato. Contatta l\'amministratore.');
            }
        }

        // üîÑ GESTIONE CLICK ESTERNI (chiudi dropdown)
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.operator-select-container')) {
                document.getElementById('operatorDropdown').classList.remove('show');
            }
            
            // Chiudi suggerimenti se click esterno
            if (!event.target.closest('.form-group')) {
                document.querySelectorAll('.field-suggestions').forEach(s => {
                    s.classList.remove('show');
                });
            }
        });

        // üéØ GESTIONE INVIO CON ENTER
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen && activeScreen.id === 'inserimento') {
                    const target = event.target;
                    if (target.tagName === 'INPUT' && target.type === 'number') {
                        event.preventDefault();
                        // Se √® nel peso lordo, vai alla tara
                        if (target.id === 'pesoLordo') {
                            document.getElementById('tara').focus();
                        }
                        // Se √® nella tara, registra la pesata
                        else if (target.id === 'tara') {
                            registraPesata();
                        }
                    }
                }
            }
        });

        // üîß UTILITY: LOG CONFIGURAZIONE
        console.log('üöÄ App Gestione Raccolto inizializzata');
        console.log('üì° API URL:', API_URL);
        console.log('üí° Per modificare l\'URL, cerca "const API_URL" nel codice sorgente');
    </script>
</body>
</html>
